
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Doctor Dashboard | Medical AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css">
  <style>
    body.light-mode {
      background: #f9fbfd;
      color: #212529;
    }
    body.dark-mode {
      background: #121212;
      color: #f1f1f1;
    }
    .card {
      border-radius: 15px;
    }
    .btn-lg {
      border-radius: 50px;
      padding: 10px 25px;
      font-weight: 600;
    }
    #ai-result {
      border-radius: 10px;
      font-size: 1rem;
      animation: fadeIn 0.6s ease-in-out;
    }
    @keyframes fadeIn {
      from {opacity:0; transform:translateY(-10px);}
      to {opacity:1; transform:translateY(0);}
    }
  </style>
</head>
<body class="light-mode">

  <!-- âœ… Navbar include -->
  <%- include('partials/navbar') %>

  <!-- âœ… Top Action Bar -->
  <div class="container-fluid mt-3">
  <div class="d-flex justify-content-between mb-3">

    <!-- ğŸ§ª Send Dummy Data Button (Left) -->
    <% if (patient) { %>
      <button 
        class="btn btn-info btn-lg shadow-sm px-4" 
        onclick="sendDummyData('<%= patient._id %>')">
        ğŸ§ª Send Dummy Data
      </button>
    <% } else { %>
      <button class="btn btn-secondary btn-lg shadow-sm px-4" disabled>
        ğŸ§ª Send Dummy Data
      </button>
    <% } %>

    <!-- ğŸ¤– AI Insights Button (Right) -->
    <% if (patient) { %>
      <button 
        class="btn btn-primary btn-lg shadow-sm px-4" 
        onclick="getAIInsights('<%= patient._id %>')">
        ğŸ¤– AI Insights
      </button>
    <% } else { %>
      <button class="btn btn-secondary btn-lg shadow-sm px-4" disabled>
        ğŸ¤– AI Insights
      </button>
    <% } %>

  </div>
</div>
  <!-- <div class="container-fluid mt-3">
  <div class="d-flex justify-content-between mb-3">

    ğŸ§ª Send Dummy Data Button (Left)
    <button 
      class="btn btn-info btn-lg shadow-sm px-4" 
      onclick="sendDummyData('<%= patient._id %>')">
      ğŸ§ª Send Dummy Data
    </button>

    ğŸ¤– AI Insights Button (Right)
    <% if (patient) { %>
      <button 
        class="btn btn-primary btn-lg shadow-sm px-4" 
        onclick="getAIInsights('<%= patient._id %>')">
        ğŸ¤– AI Insights
      </button>
    <% } else { %>
      <button class="btn btn-secondary btn-lg shadow-sm px-4" disabled>
        ğŸ¤– AI Insights
      </button>
    <% } %>

  </div>
</div> -->


  <!-- Send Dummy Data Button  -->
  <!-- <div class="d-flex justify-content-end mb-3">
  <button 
    class="btn btn-warning btn-lg" 
    onclick="sendDummyData('<%= patient._id %>')">
    ğŸ§ª Send Dummy Data
  </button>
</div> -->


  <!-- âœ… KPI Cards -->
  <div class="container py-4">
    <div class="row g-4 text-center">

      <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm p-3">
          <h6>Total Patients</h6>
          <h3><%= totalPatients %></h3>
          <span class="text-success fw-bold">+12%</span>
        </div>
      </div>

      <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm p-3">
          <h6>Today's Appointments</h6>
          <h3><%= appointmentsToday %></h3>
          <span class="text-primary fw-bold">+3</span>
        </div>
      </div>

      <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm p-3">
          <h6>Critical Alerts</h6>
          <h3><%= criticalAlerts %></h3>
          <span class="text-danger fw-bold">-2</span>
        </div>
      </div>

      <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm p-3">
          <h6>New Patients</h6>
          <h3><%= newPatients %></h3>
          <span class="text-success fw-bold">+3</span>
        </div>
      </div>

    </div>
  </div>

  <!-- âœ… Page Title -->
  <h2 class="text-center mt-4 text-primary fw-bold">Monitoring: <%= patientName %></h2>

  <!-- âœ… Patient Info + Vitals -->
  <div class="container py-3">
    <div class="row g-4">
      
      <!-- Patient Info -->
      <div class="col-md-4">
        <div class="card shadow">
          <% if (patient && patient.image) { %>
            <img src="<%= patient.image %>" class="card-img-top" alt="Patient Image"
                 style="width: 100%; height: 250px; object-fit: contain;">
          <% } else { %>
            <img src="/images/profile-placeholder.png" class="card-img-top" alt="Default Patient Image"
                 style="width: 100%; height: 250px; object-fit: contain;">
          <% } %>
          <div class="card-body text-center">
            <h5 class="card-title mb-2"><%= patient?.name || 'No Patient' %></h5>
            <p>
              <strong>Age:</strong> <%= patient?.age || 'N/A' %><br>
              <strong>Gender:</strong> <%= patient?.gender || 'N/A' %>
            </p>
          </div>
        </div>
      </div>

      <!-- Vitals + Charts -->
      <div class="col-md-8">
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card text-white bg-danger shadow">
              <div class="card-header">â¤ï¸ Heart Rate</div>
              <div class="card-body">
                <h5><%= latest ? latest.heartRate + ' bpm' : 'No data available' %></h5>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card text-white bg-primary shadow">
              <div class="card-header">ğŸ« SpOâ‚‚</div>
              <div class="card-body">
                <h5><%= latest ? latest.spo2 + ' %' : 'No data available' %></h5>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row">
          <div class="col-md-6">
            <h5>Heart Rate Trend</h5>
            <canvas id="heartChart" class="border rounded shadow-sm mb-4" height="200"></canvas>
          </div>
          <div class="col-md-6">
            <h5>SpOâ‚‚ Trend</h5>
            <canvas id="spo2Chart" class="border rounded shadow-sm mb-4" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const labels = <%- JSON.stringify(labels) %>;
    const heartValues = <%- JSON.stringify(heartValues) %>;
    const spo2Values = <%- JSON.stringify(spo2Values) %>;

    new Chart(document.getElementById('heartChart'), {
      type: 'line',
      data: { labels, datasets: [{
        label: 'Heart Rate',
        data: heartValues,
        borderColor: '#e63946',
        backgroundColor: 'rgba(230,57,70,0.15)',
        fill: true, tension: 0.4
      }]},
      options: { responsive: true, animation: { duration: 1200, easing: 'easeOutQuart' } }
    });

    new Chart(document.getElementById('spo2Chart'), {
      type: 'line',
      data: { labels, datasets: [{
        label: 'SpOâ‚‚',
        data: spo2Values,
        borderColor: '#0077b6',
        backgroundColor: 'rgba(0,119,182,0.15)',
        fill: true, tension: 0.4
      }]},
      options: { responsive: true, animation: { duration: 1200, easing: 'easeOutQuart' } }
    });

    // Dark Mode Toggle
    const toggleBtn = document.getElementById("themeToggle");
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      toggleBtn.textContent = document.body.classList.contains("dark-mode")
        ? "â˜€ï¸ Light Mode" : "ğŸŒ™ Dark Mode";
    });

    // AI Insights
    async function getAIInsights(patientId) {
      try {
        const res = await fetch(`/patient/${patientId}/ai-insights`, {
          method: "POST", headers: { "Content-Type": "application/json" }
        });
        if (!res.ok) throw new Error("Failed to fetch AI insights");
        const data = await res.json();
        const resultBox = document.getElementById("ai-result");
        resultBox.style.display = "block";

        if (data.status === "critical") {
          resultBox.className = "alert alert-danger mx-4";
          resultBox.innerHTML = `<strong>âš ï¸ Emergency:</strong> ${data.insight}`;
        } else if (data.status === "warning") {
          resultBox.className = "alert alert-warning mx-4";
          resultBox.innerHTML = `<strong>âš ï¸ Warning:</strong> ${data.insight}`;
        } else {
          resultBox.className = "alert alert-success mx-4";
          resultBox.innerHTML = `<strong>âœ… Stable:</strong> ${data.insight || "Vitals normal"}`;
        }
      } catch (err) {
        console.error("Error:", err);
        alert("Could not fetch AI insights");
      }
    }
    async function sendDummyData(patientId) {
  try {
    const res = await fetch(`/simulate/dummy/${patientId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });

    if (!res.ok) throw new Error("Failed to send dummy data");

    const result = await res.json();
    alert(`âœ… Dummy data generated for ${result.data.patientName}
Heart Rate: ${result.data.heartRate} bpm
SpOâ‚‚: ${result.data.spo2} %
Weight: ${result.data.weight} kg`);

    // ğŸ”„ Reload dashboard to show latest vitals
    window.location.reload();
  } catch (err) {
    console.error("Dummy data error:", err);
    alert("âŒ Could not generate dummy data");
  }
}

  </script>
</body>
</html>




